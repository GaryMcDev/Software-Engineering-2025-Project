<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Data</title>
    <link rel="stylesheet" href="data-page.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Device Data</h1>
    <div class="container">
        <div class="button-container">
            <div class="logging-control-container">
                <button id="startButton" class="toggle-button" data-action="start">Start Logging</button>
                <button id="stopButton" class="toggle-button active" data-action="stop">Stop Logging</button>
            </div>
            <div class="data-view-container">
                <button class="toggle-button active" data-view="all">All Data</button>
                <button class="toggle-button" data-view="internal">Internal Only</button>
                <button class="toggle-button" data-view="external">External Only</button>
            </div>
            <div class="temp-unit-container">
                <button class="toggle-button temp-unit-button active" data-unit="C">°C</button>
                <button class="toggle-button temp-unit-button" data-unit="F">°F</button>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="lineChart"></canvas>
        </div>
        <div class="button-container">
            <div class="weight-slider-container">
                <label for="weightSlider">Weight (lbs):</label>
                <input type="range" id="weightSlider" class="weight-slider" min="0.1" max="5" step="0.1" value="1">
                <div class="weight-value" id="weightValue">1.0 lbs</div>
            </div>
            <button class="toggle-button meat-button" data-meat="pork" data-value="0">
                Pork
                <div class="meat-value">Value: 0</div>
            </button>
            <button class="toggle-button meat-button" data-meat="steak" data-value="1">
                Steak
                <div class="meat-value">Value: 1</div>
            </button>
            <button class="toggle-button meat-button" data-meat="chicken" data-value="2">
                Chicken
                <div class="meat-value">Value: 2</div>
            </button>
            <button class="toggle-button meat-button" data-meat="fish" data-value="3">
                Fish
                <div class="meat-value">Value: 3</div>
            </button>
            <button class="toggle-button meat-button" data-meat="lamb" data-value="4">
                Lamb
                <div class="meat-value">Value: 4</div>
            </button>
        </div>
    </div>
    <div id="deviceData">Loading device data...</div>
    <div id="errorMessage" class="error-message">
        No device detected. Please check your connection and try again.
        <button class="retry-button" onclick="retryConnection()">Retry</button>
    </div>
    <script>
        // Initialize empty arrays for data
        let timeData = [];
        let temperatureData = [];
        let externalTempData = [];
        let predictedTempData = []; // Array for predicted temperature data
        let selectedMeatValue = 0; // Store the selected meat value (0 for pork by default)
        let selectedWeight = 1.0; // Store the selected weight value
        let selectedTempUnit = 'C'; // Store the selected temperature unit

        // Weight slider functionality
        const weightSlider = document.getElementById('weightSlider');
        const weightValue = document.getElementById('weightValue');
        
        weightSlider.addEventListener('input', function() {
            selectedWeight = parseFloat(this.value);
            weightValue.textContent = selectedWeight.toFixed(1) + ' lbs';
            console.log('Selected weight:', selectedWeight);
        });

        // Function to convert Celsius to Fahrenheit
        function celsiusToFahrenheit(celsius) {
            return (celsius * 9/5) + 32;
        }

        // Function to convert Fahrenheit to Celsius
        function fahrenheitToCelsius(fahrenheit) {
            return (fahrenheit - 32) * 5/9;
        }

        // Function to convert temperature data for display
        function convertTemperatureData(data, toFahrenheit) {
            return data.map(temp => toFahrenheit ? celsiusToFahrenheit(temp) : temp);
        }

        // Function to show error message
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.classList.add('show');
        }

        // Function to hide error message
        function hideError() {
            const errorElement = document.getElementById('errorMessage');
            errorElement.classList.remove('show');
        }

        // Function to retry connection
        function retryConnection() {
            hideError();
            document.getElementById('deviceData').textContent = 'Loading device data...';
            // Add your retry logic here
            // For example, reinitialize the device connection
            console.log('Retrying device connection...');
        }

        // Function to add new data points
        function addData(time, temperature, externalTemp) {
            timeData.push(time);
            temperatureData.push(temperature);
            externalTempData.push(externalTemp);
            
            // Update predicted temperature data
            if (selectedMeatValue !== null) {
                //call thte python function
            }
            
            updateChart();
            hideError(); // Hide error message when data is successfully added
        }

        // Function to update the chart
        function updateChart() {
            lineChart.data.labels = timeData;
            
            // Convert temperatures based on selected unit
            const displayTempData = convertTemperatureData(temperatureData, selectedTempUnit === 'F');
            const displayExternalTempData = convertTemperatureData(externalTempData, selectedTempUnit === 'F');
            
            lineChart.data.datasets[0].data = displayTempData;
            lineChart.data.datasets[1].data = displayExternalTempData;
            
            // Only show predicted data if we have enough points
            if (temperatureData.length > 0) {
                // Start with the same points as internal temperature
                predictedTempData = [...temperatureData];
                
                // Add 5 predicted points extending from the last internal temperature
                const lastInternalTemp = temperatureData[temperatureData.length - 1];
                for (let i = 1; i <= 5; i++) {
                    const predictedTemp = lastInternalTemp + (Math.random() * 10 - 5); // Random variation of ±5°C
                    predictedTempData.push(predictedTemp);
                }
                
                // Convert predicted data for display
                const displayPredictedTempData = convertTemperatureData(predictedTempData, selectedTempUnit === 'F');
                lineChart.data.datasets[2].data = displayPredictedTempData;
            }
            
            // Update y-axis label based on temperature unit
            lineChart.options.scales.y.title.text = `Temperature (${selectedTempUnit})`;
            
            lineChart.update();
        }

        const ctx = document.getElementById('lineChart').getContext('2d');
        const lineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timeData,
                datasets: [
                    {
                        label: 'Internal Temperature',
                        data: temperatureData,
                        borderColor: 'blue',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 5,
                        pointBackgroundColor: 'blue'
                    },
                    {
                        label: 'External Temperature',
                        data: externalTempData,
                        borderColor: 'green',
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 5,
                        pointBackgroundColor: 'green'
                    },
                    {
                        label: 'Target Point',
                        data: [],
                        borderColor: 'red',
                        borderWidth: 0,
                        fill: true,
                        pointRadius: 8,
                        pointBackgroundColor: 'red',
                        pointStyle: 'star'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time (seconds)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Temperature (C)'
                        },
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });

        // Temperature view toggle button functionality
        const viewButtons = document.querySelectorAll('.toggle-button[data-view]');
        viewButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all view buttons
                viewButtons.forEach(btn => btn.classList.remove('active'));
                // Add active class to clicked button
                button.classList.add('active');

                const view = button.dataset.view;
                // Update chart visibility based on selected view
                lineChart.data.datasets[0].hidden = view === 'external';
                lineChart.data.datasets[1].hidden = view === 'internal';
                // Only show prediction when internal temperature is visible
                lineChart.data.datasets[2].hidden = view === 'external' || view === 'all';
                lineChart.update();
            });
        });

        // Meat selection button functionality
        const meatButtons = document.querySelectorAll('.meat-button');
        meatButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all meat buttons
                meatButtons.forEach(btn => btn.classList.remove('active'));
                // Add active class to clicked button
                button.classList.add('active');

                // Store the selected meat value
                selectedMeatValue = parseInt(button.dataset.value);
                console.log(`Selected meat value: ${selectedMeatValue}`);
                
                // Update predictions based on new meat selection
                if (timeData.length > 1) {
                    predictedTempData = fitExponentialDecay(timeData, temperatureData, externalTempData);
                    updateChart();
                }
            });
        });

        // Update weight slider to trigger heat transfer calculation
        weightSlider.addEventListener('input', function() {
            selectedWeight = parseFloat(this.value);
            weightValue.textContent = selectedWeight.toFixed(1) + ' lbs';
            console.log('Selected weight:', selectedWeight);
            
            // Update predictions based on new weight
            if (timeData.length > 1) {
                predictedTempData = fitExponentialDecay(timeData, temperatureData, externalTempData);
                updateChart();
            }
        });

        // Temperature unit toggle button functionality
        const tempUnitButtons = document.querySelectorAll('.temp-unit-button');
        tempUnitButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all temp unit buttons
                tempUnitButtons.forEach(btn => btn.classList.remove('active'));
                // Add active class to clicked button
                button.classList.add('active');

                // Update selected temperature unit
                selectedTempUnit = button.dataset.unit;
                console.log(`Selected temperature unit: ${selectedTempUnit}`);
                
                // Update the chart with converted temperatures
                updateChart();
            });
        });

        // Make pork selected by default
        document.addEventListener('DOMContentLoaded', function() {
            const porkButton = document.querySelector('[data-meat="pork"]');
            if (porkButton) {
                porkButton.classList.add('active');
                selectedMeatValue = 0;
                console.log('Pork selected by default');
            }
        });

        // Example of how to handle device detection failure
        // This would typically be in your device connection logic
        setTimeout(() => {
            // Simulate device detection failure
            showError('No device detected. Please check your connection and try again.');
        }, 5000); // This is just for demonstration - remove in production
    </script>
    <script src="data-page.js"></script>
</body>
</html>
